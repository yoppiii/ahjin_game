<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì•„ì§„ì´ ê²Œì„ - ë°©ì†¡</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap');

    html, body {
      height:100%; margin:0;
      background: linear-gradient(135deg, #fce4ec 0%, #e8eaf6 50%, #e0f7fa 100%);
      font-family: 'Noto Sans KR', system-ui, -apple-system, sans-serif;
      display:flex; justify-content:center; align-items:center;
    }
    #gameWrap{
      aspect-ratio:3/4;
      height:100vh; max-height:100vh; width:auto;
      background: linear-gradient(180deg, #fff5f9 0%, #f0f4ff 40%, #eafaf7 100%);
      position:relative; overflow:hidden;
      box-shadow: 0 8px 40px rgba(0,0,0,0.08);
    }

    /* ë’¤ë¡œ ë²„íŠ¼ */
    #backBtn{
      position:absolute; top:14px; left:14px; z-index:30;
      width:44px; height:44px;
      border:none; border-radius:50%;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(10px);
      color:#7c7c8a; font-size:18px; font-weight:700;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      font-family: 'Noto Sans KR', sans-serif;
      transition: all 0.2s ease;
    }
    #backBtn:active { transform: scale(0.9); }

    /* ë°©ì†¡ íƒ€ì´í‹€ */
    #broadcastTitle {
      position:absolute; top:16px; left:50%; transform:translateX(-50%);
      z-index:30;
      font-size:16px; font-weight:900;
      background: linear-gradient(135deg, #fff3b0, #ffe066);
      padding:8px 20px;
      border-radius:20px;
      color:#b8860b;
      box-shadow: 0 3px 12px rgba(255,224,102,0.3);
    }

    /* ë©”ë‰´ ê·¸ë¦¬ë“œ */
    #menuGrid {
      position:absolute; top:66px; left:50%; transform:translateX(-50%);
      width:90%; z-index:20;
      display:flex; flex-direction:column; gap:8px;
    }
    .menu-row { display:flex; gap:8px; justify-content:center; }
    .menu-btn {
      flex:1; height:44px;
      border:none; border-radius:14px;
      font-weight:700; font-size:12px;
      cursor:pointer;
      font-family: 'Noto Sans KR', sans-serif;
      display:flex; align-items:center; justify-content:center; gap:4px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
    }
    .menu-btn:active { transform: scale(0.94); }
    .menu-add { background: rgba(255,255,255,0.8); backdrop-filter: blur(10px); color:#999; font-size:20px; flex:0 0 44px; border: 2px dashed #ddd; }
    .menu-pink { background: linear-gradient(135deg, #ffd6e8, #ffb6c1); color:#c2185b; }
    .menu-orange { background: linear-gradient(135deg, #ffe0cc, #ffab91); color:#d84315; }
    .menu-purple { background: linear-gradient(135deg, #e8d5f5, #ce93d8); color:#7b1fa2; }
    .menu-mint { background: linear-gradient(135deg, #d4f5e9, #a5d6a7); color:#2e7d32; }
    .menu-yellow { background: linear-gradient(135deg, #fff9c4, #fff176); color:#f9a825; }
    .menu-blue { background: linear-gradient(135deg, #d6eaff, #b3d4fc); color:#1565c0; }
    .menu-peach { background: linear-gradient(135deg, #ffe8d6, #ffcc80); color:#e65100; }

    /* ìºë¦­í„° - ì „ì²´ í•˜ë‹¨ì— ê¹”ë¦¼ */
    #characterArea {
      position:absolute; left:0; right:0; bottom:0; top:150px;
      z-index:5;
    }
    #characterArea canvas { width:100%; height:100%; display:block; }

    /* í•˜íŠ¸ */
    #hearts {
      position:absolute; right:14px; top:170px; z-index:20;
      display:flex; flex-direction:column; gap:6px; align-items:center;
    }
    .heart { font-size:20px; animation: heartFloat 2s ease-in-out infinite; opacity:0.7; }
    .heart:nth-child(1) { animation-delay:0s; }
    .heart:nth-child(2) { animation-delay:0.3s; }
    .heart:nth-child(3) { animation-delay:0.6s; }
    .heart:nth-child(4) { animation-delay:0.9s; }
    .heart:nth-child(5) { animation-delay:1.2s; }
    @keyframes heartFloat {
      0%, 100% { transform: translateY(0); opacity:0.5; }
      50% { transform: translateY(-6px); opacity:1; }
    }

    /* ì±„íŒ… ì˜ì—­ - íˆ¬ëª… ë°°ê²½ */
    #chatArea {
      position:absolute; left:0; right:0; bottom:0; top:50%;
      z-index:25;
      display:flex; flex-direction:column;
      background: transparent;
    }
    #chatMessages {
      flex:1; overflow-y:auto;
      padding:12px 14px;
      display:flex; flex-direction:column; gap:8px;
      scroll-behavior: smooth;
    }
    .msg {
      max-width:80%; padding:10px 14px;
      border-radius:18px; font-size:13px; line-height:1.5;
      word-break:break-word;
      animation: msgIn 0.2s ease;
    }
    @keyframes msgIn {
      from { opacity:0; transform: translateY(8px); }
      to { opacity:1; transform: translateY(0); }
    }
    .msg-user {
      align-self:flex-end;
      background: linear-gradient(135deg, #a5d6a7, #81c784);
      color:#1b5e20;
      border-bottom-right-radius:6px;
    }
    .msg-bot {
      align-self:flex-start;
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(8px);
      color:#333;
      border-bottom-left-radius:6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .msg-bot .bot-name { font-size:10px; font-weight:700; color:#ce93d8; margin-bottom:2px; }
    .msg-system {
      align-self:center; font-size:11px; color:#999;
      background: rgba(255,255,255,0.5); padding:4px 12px; border-radius:12px;
    }
    .msg-typing {
      align-self:flex-start;
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(8px);
      color:#aaa;
      border-bottom-left-radius:6px; font-size:13px;
    }
    .typing-dots span { animation: blink 1.4s infinite; }
    .typing-dots span:nth-child(2) { animation-delay:0.2s; }
    .typing-dots span:nth-child(3) { animation-delay:0.4s; }
    @keyframes blink {
      0%, 60%, 100% { opacity:0.2; }
      30% { opacity:1; }
    }
    #chatInput {
      display:flex; gap:8px;
      padding:10px 14px;
      background: rgba(255,255,255,0.4);
      backdrop-filter: blur(10px);
    }
    #chatInput input {
      flex:1; padding:10px 16px;
      border:none; border-radius:22px;
      background: rgba(255,255,255,0.9);
      font-size:14px;
      font-family: 'Noto Sans KR', sans-serif;
      outline:none;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    #chatInput input::placeholder { color:#bbb; }
    #chatInput button {
      width:42px; height:42px;
      border:none; border-radius:50%;
      background: linear-gradient(135deg, #f48fb1, #ce93d8);
      color:#fff; font-size:18px;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(206,147,216,0.3);
    }
    #chatInput button:active { transform: scale(0.9); }
    #chatInput button:disabled { opacity:0.5; }
  </style>
</head>

<body>
  <div id="gameWrap">
    <button id="backBtn">â†</button>
    <div id="broadcastTitle">ğŸ“¡ ë°©ì†¡</div>

    <div id="menuGrid">
      <div class="menu-row">
        <div class="menu-btn menu-add" data-act="ì¶”ê°€">ï¼‹</div>
        <div class="menu-btn menu-pink" data-act="ì¹œêµ¬ë°©">ğŸ‘« ì¹œêµ¬ë°©</div>
        <div class="menu-btn menu-orange" data-act="ìš”ë¦¬ë°©">ğŸ³ ìš”ë¦¬ë°©</div>
        <div class="menu-btn menu-purple" data-act="ê¾¸ë¯¸ê¸°ë°©">âœ¨ ê¾¸ë¯¸ê¸°ë°©</div>
      </div>
      <div class="menu-row">
        <div class="menu-btn menu-mint" data-act="ìƒí™œë°©">ğŸ  ìƒí™œë°©</div>
        <div class="menu-btn menu-yellow" data-act="ì±Œë¦°ì§€">ğŸ† ì±Œë¦°ì§€</div>
        <div class="menu-btn menu-blue" data-act="ê²œë°©">ğŸ® ê²œë°©</div>
        <div class="menu-btn menu-peach" data-act="ë¨¹ë°©">ğŸ” ë¨¹ë°©</div>
      </div>
    </div>

    <div id="hearts">
      <div class="heart">ğŸ’—</div>
      <div class="heart">ğŸ’•</div>
      <div class="heart">ğŸ’–</div>
      <div class="heart">ğŸ’—</div>
      <div class="heart">ğŸ’•</div>
    </div>

    <div id="characterArea">
      <canvas id="game"></canvas>
    </div>

    <div id="chatArea">
      <div id="chatMessages">
        <div class="msg msg-bot">
          <div class="bot-name">ğŸ¤– ì‹¬ì‹¬ì´</div>
          ì•ˆë…•! ë°©ì†¡ì— ì˜¨ ê±¸ í™˜ì˜í•´~ ë¬´ìŠ¨ ì–˜ê¸° í• ê¹Œ? ğŸ’¬
        </div>
      </div>
      <div id="chatInput">
        <input type="text" id="msgInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" />
        <button id="sendBtn">â¤</button>
      </div>
    </div>
  </div>

  <script>
    // â”€â”€ ìºë¦­í„° â”€â”€
    const ASSETS = { girl: "girl_broadcast.png", boy: "boy_broadcast.png" };
    const params = new URLSearchParams(location.search);
    const gender = (params.get("gender") === "boy") ? "boy" : "girl";

    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    let images = {};

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      draw();
    }
    window.addEventListener("resize", resize);

    function loadImage(src){
      return new Promise((res, rej)=>{
        const img = new Image();
        img.onload = ()=>res(img);
        img.onerror = ()=>rej(new Error("ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: " + src));
        img.src = src;
      });
    }

    function draw(){
      const w = canvas.clientWidth;
      const h = canvas.clientHeight;
      ctx.clearRect(0,0,w,h);
      const img = images[gender];
      if(!img) return;
      const scaleW = w / img.width;
      const scaleH = h / img.height;
      const scale = Math.max(scaleW, scaleH);
      const dw = img.width * scale;
      const dh = img.height * scale;
      const x = (w - dw) / 2;
      const y = h - dh;
      ctx.drawImage(img, x, y, dw, dh);
    }

    // â”€â”€ ë„¤ë¹„ê²Œì´ì…˜ â”€â”€
    document.getElementById("backBtn").onclick = ()=> {
      location.href = `main.html?gender=${encodeURIComponent(gender)}`;
    };
    document.getElementById("menuGrid").addEventListener("click", (e)=>{
      const el = e.target.closest("[data-act]");
      if(!el) return;
      alert("í´ë¦­: " + el.dataset.act);
    });

    // â”€â”€ ê·€ì—¬ìš´ ì±—ë´‡ (í† ë¼ë´‡ ğŸ°) â”€â”€
    const chatMessages = document.getElementById("chatMessages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");

    const BOT_NAME = "ì‹¬ì‹¬ì´";
    const BOT_ICON = "ğŸ¤–";
    const CHAT_API_URL = resolveChatApiUrl();
    let apiNoticeShown = false;

    function resolveChatApiUrl() {
      const q = new URLSearchParams(location.search).get("api");
      if (q && q.trim()) localStorage.setItem("AHJIN_CHAT_API_URL", q.trim());
      const saved = localStorage.getItem("AHJIN_CHAT_API_URL");
      const base = (q || saved || "").trim();
      if (!base) return "/api/chat";
      const normalizedBase = base.endsWith("/") ? base.slice(0, -1) : base;
      return normalizedBase.endsWith("/api/chat") ? normalizedBase : `${normalizedBase}/api/chat`;
    }

    // íŒ¨í„´ ë§¤ì¹­ ì‘ë‹µ
    const PATTERNS = [
      { match: /ì•ˆë…•|í•˜ì´|í—¬ë¡œ|hi|hello/i, replies: ["ì•ˆë…•ì•ˆë…•! ğŸ°âœ¨ ì˜¤ëŠ˜ ê¸°ë¶„ ì–´ë•Œ?", "í•˜ì´~ ë°˜ê°€ì›Œ! ğŸ’•", "ì•ˆë…•! ì˜¤ëŠ˜ë„ ë°©ì†¡ ì™”êµ¬ë‚˜~ ğŸ‰"] },
      { match: /ì´ë¦„|ëˆ„êµ¬/i, replies: ["ë‚˜ëŠ” í† ë¼ë´‡ì´ì•¼! ğŸ° ì´ ë°©ì†¡êµ­ì˜ ë§ˆìŠ¤ì½”íŠ¸ì§€~", "í† ë¼ë´‡ì´ë¼ê³  í•´! ë°©ì†¡ ë„ìš°ë¯¸ì•¼ ğŸ°ğŸ’«"] },
      { match: /ë­í•´|ë­˜í•´|ë­í•˜/i, replies: ["ë°©ì†¡ ë³´ë©´ì„œ ë†€ê³  ìˆì§€~ ğŸ¬", "ì±„íŒ…í•˜ë©´ì„œ ì¹œêµ¬ë“¤ ê¸°ë‹¤ë¦¬ê³  ìˆì—ˆì–´! ğŸ’¬", "ë‹¹ê·¼ ë¨¹ìœ¼ë©´ì„œ ë°©ì†¡ ì¤€ë¹„ ì¤‘ ğŸ¥•"] },
      { match: /ì¢‹ì•„|ì‚¬ë‘|ìµœê³ /i, replies: ["í—¤í—¤ ë‚˜ë„ ì¢‹ì•„! ğŸ’—", "ê³ ë§ˆì›Œ~ ë„ˆë„ ìµœê³ ì•¼! â­", "ì‚¬ë‘í•´~ ğŸ’•ğŸ°"] },
      { match: /ì‹«ì–´|ë³„ë¡œ|ë‚˜ë¹ /i, replies: ["ì•— ë¯¸ì•ˆ ã… ã…  ë‹¤ìŒì—” ë” ì˜í• ê²Œ!", "íì—¥... ê¸°ìš´ë‚´ì! ğŸŒˆ", "ê´œì°®ì•„ ê´œì°®ì•„~ í† ë‹¥í† ë‹¥ ğŸ°ğŸ’•"] },
      { match: /ê²Œì„|ê²œ/i, replies: ["ê²Œì„ ì¢‹ì§€! ë­ í•˜ê³  ì‹¶ì–´? ğŸ®", "ê²œë°©ì—ì„œ ê°™ì´ ë†€ê¹Œ? ğŸ•¹ï¸", "ì˜¤ëŠ˜ì€ ì–´ë–¤ ê²Œì„ í• ê¹Œ~ ğŸ²"] },
      { match: /ìš”ë¦¬|ìŒì‹|ë¨¹/i, replies: ["ë‹¹ê·¼ ì¼€ì´í¬ ë§Œë“¤ì! ğŸ¥•ğŸ‚", "ìš”ë¦¬ ì¢‹ì•„! ë­ ë§Œë“¤ê¹Œ? ğŸ³", "ë¨¹ë°© í•  ì‹œê°„ì¸ê°€~? ğŸ”ğŸ•ğŸ°"] },
      { match: /ì¹œêµ¬/i, replies: ["ì¹œêµ¬ ì¢‹ì§€! ë‚˜ë„ ë„¤ ì¹œêµ¬ì•¼~ ğŸ°ğŸ’•", "ì¹œêµ¬ë“¤ì´ë‘ ê°™ì´ ë°©ì†¡í•˜ë©´ ë” ì¬ë°Œì–´! ğŸ‘«", "ìš°ë¦¬ ì¹œêµ¬í•˜ì! âœ¨"] },
      { match: /ê¾¸ë¯¸|ì˜ˆì˜|ì˜·/i, replies: ["ê¾¸ë¯¸ê¸° ì¢‹ì•„! ì˜¤ëŠ˜ì€ ì–´ë–¤ ìŠ¤íƒ€ì¼? ğŸ‘—âœ¨", "ì˜ˆì˜ê²Œ ê¾¸ë©°ë³´ì~ ë¦¬ë³¸ ë‹¬ê¹Œ? ğŸ€", "íŒ¨ì…˜ì‡¼ í• ê¹Œ? ğŸŒŸ"] },
      { match: /ë…¸ë˜|ìŒì•…|ì¶¤/i, replies: ["ë„ë¼ë¼~ ğŸµ ê°™ì´ ë…¸ë˜í•˜ì!", "ëŒ„ìŠ¤ íƒ€ì„! ğŸ’ƒğŸ•º", "í† ë¼ ëŒ„ìŠ¤ ë³´ì—¬ì¤„ê¹Œ? ğŸ°ğŸ¶"] },
      { match: /ìŠ¬í¼|ìš¸ì–´|í˜ë“¤/i, replies: ["ê´œì°®ì•„, ë‚´ê°€ ì˜†ì— ìˆì–ì•„ ğŸ°ğŸ’•", "ìš¸ì§€ë§ˆ~ í† ë¼ê°€ ì•ˆì•„ì¤„ê²Œ ğŸ«‚", "í˜ë“  ë‚ ë„ ìˆì§€... ê°™ì´ ë‹¹ê·¼ ë¨¹ì ğŸ¥•"] },
      { match: /ã…‹ã…‹|ã…ã…|ì›ƒ|ì¬ë°Œ/i, replies: ["ã…‹ã…‹ã…‹ ë§ì•„ ë„ˆë¬´ ì›ƒê²¨! ğŸ˜‚", "ã…ã… ì¬ë°Œì§€~ ğŸ¤£", "ê¹”ê¹”ê¹”! ğŸ°ğŸ˜†"] },
      { match: /ê³ ë§ˆ|ê°ì‚¬|ë•¡í|thanks/i, replies: ["ì²œë§Œì—~ ğŸ°âœ¨", "í—¤í—¤ ë³„ë§ì”€ì„! ğŸ’•", "ê³ ë§ˆì›Œ í•˜ë©´ ë‹¹ê·¼ìœ¼ë¡œ ê°šì•„ì¤˜~ ğŸ¥•"] },
      { match: /ë°”ì´|ì˜ê°€|ì•ˆë…•íˆ/i, replies: ["ì˜ê°€~ ë‹¤ìŒì— ë˜ ì™€! ğŸ‘‹ğŸ°", "ë°”ì´ë°”ì´~ ë³´ê³ ì‹¶ì„ê±°ì•¼! ğŸ’•", "ì•ˆë…•~ ë˜ ë†€ëŸ¬ì™€! ğŸŒŸ"] },
      { match: /ì‹¬ì‹¬|ì§€ë£¨/i, replies: ["ì‹¬ì‹¬í•´? ê²Œì„í•˜ì! ğŸ®", "ë‚˜ë‘ ìˆ˜ë‹¤ ë–¨ì~ ğŸ’¬ğŸ°", "ì§€ë£¨í•  í‹ˆ ì—†ê²Œ í•´ì¤„ê²Œ! âœ¨"] },
      { match: /ê±°ë¶|turtle/i, replies: ["ê±°ë¶ì´! ë‚´ ì¹œêµ¬ì•¼~ ğŸ¢ğŸ’š", "ê±°ë¶ì´ëŠ” ëŠë¦¬ì§€ë§Œ ë©‹ì ¸! ğŸ¢âœ¨", "ê±°ë¶ì´ë„ ë°©ì†¡ ë³´ê³ ìˆì–´~ ğŸ¢"] },
      { match: /ë°©ì†¡|ë¼ì´ë¸Œ|live/i, replies: ["ë°©ì†¡ ì‹œì‘! ğŸ“¡ ì˜¤ëŠ˜ ë­ í• ê¹Œ?", "LIVE ON! ğŸ”´ ì‹œì²­ì ì—¬ëŸ¬ë¶„ ì•ˆë…•~", "ë°©ì†¡êµ­ì— ì˜¨ ê±¸ í™˜ì˜í•´! ğŸ¬âœ¨"] },
    ];

    const FALLBACKS = [
      "ì˜¤í˜¸~ ê·¸ë ‡êµ¬ë‚˜! ğŸ°",
      "ì¬ë°Œë‹¤! ë” ì–˜ê¸°í•´ì¤˜~ ğŸ’¬",
      "ìŒ... ë‹¹ê·¼ ë¨¹ìœ¼ë©´ì„œ ìƒê°í•´ë³¼ê²Œ ğŸ¥•ğŸ¤”",
      "ê·¸ë˜ê·¸ë˜~ ğŸ°âœ¨",
      "í—¤í—¤ ê·¸ë ‡êµ¬ë‚˜! ğŸ’•",
      "ì˜¤~ ì‹ ê¸°í•´! ë” ì•Œë ¤ì¤˜! ğŸŒŸ",
      "í† ë¼ëŠ” ì˜ ëª¨ë¥´ì§€ë§Œ ë©‹ì§„ ê²ƒ ê°™ì•„! ğŸ°",
      "ì™€~ ëŒ€ë°•! ğŸ˜²âœ¨",
      "ìŒëƒ ìŒëƒ... ğŸ°ğŸ’¤ ì•„ ê¹œë¹¡ ì¡¸ì•˜ì–´!",
      "ê·¸ê±´ ë‹¹ê·¼ë³´ë‹¤ ì¬ë°Œì–´? ğŸ¥•",
    ];

    function getBotReply(text) {
      for (const p of PATTERNS) {
        if (p.match.test(text)) {
          return p.replies[Math.floor(Math.random() * p.replies.length)];
        }
      }
      return FALLBACKS[Math.floor(Math.random() * FALLBACKS.length)];
    }

    async function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;

      addUserMessage(text);
      msgInput.value = "";
      showTyping();
      sendBtn.disabled = true;

      try {
        const reply = await requestApiReply(text);
        removeTyping();
        addBotMessage(reply || getBotReply(text));
      } catch (err) {
        console.error(err);
        removeTyping();
        addBotMessage(getBotReply(text));
        if (!apiNoticeShown) {
          apiNoticeShown = true;
          addSystemMessage("API ì—°ê²°ì´ ë¶ˆì•ˆì •í•´ì„œ ì„ì‹œ ë¡œì»¬ ì‘ë‹µìœ¼ë¡œ ì „í™˜í–ˆì–´.");
        }
      } finally {
        sendBtn.disabled = false;
        msgInput.focus();
      }
    }

    async function requestApiReply(text) {
      const res = await fetch(CHAT_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: text,
          lang: "ko",
        }),
      });
      if (!res.ok) {
        throw new Error("chat api error: " + res.status);
      }
      const data = await res.json();
      if (!data || typeof data.reply !== "string" || !data.reply.trim()) {
        throw new Error("empty chat reply");
      }
      return data.reply.trim();
    }

    // â”€â”€ UI í—¬í¼ â”€â”€
    function addUserMessage(text) {
      const div = document.createElement("div");
      div.className = "msg msg-user";
      div.textContent = text;
      chatMessages.appendChild(div);
      scrollToBottom();
    }

    function addBotMessage(text) {
      const div = document.createElement("div");
      div.className = "msg msg-bot";
      div.innerHTML = `<div class="bot-name">${BOT_ICON} ${BOT_NAME}</div>${escapeHtml(text)}`;
      chatMessages.appendChild(div);
      scrollToBottom();
    }

    function addSystemMessage(text) {
      const div = document.createElement("div");
      div.className = "msg msg-system";
      div.textContent = text;
      chatMessages.appendChild(div);
      scrollToBottom();
    }

    function showTyping() {
      removeTyping();
      const div = document.createElement("div");
      div.className = "msg msg-typing";
      div.id = "typingIndicator";
      div.innerHTML = '<span class="typing-dots"><span>â—</span> <span>â—</span> <span>â—</span></span>';
      chatMessages.appendChild(div);
      scrollToBottom();
    }

    function removeTyping() {
      const el = document.getElementById("typingIndicator");
      if (el) el.remove();
    }

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function escapeHtml(t) {
      return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>");
    }

    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.isComposing) {
        e.preventDefault();
        sendMessage();
      }
    });

    // â”€â”€ ì‹œì‘ â”€â”€
    (async function init(){
      images.girl = await loadImage(ASSETS.girl);
      images.boy  = await loadImage(ASSETS.boy);
      resize();
      addSystemMessage(`ì‹¬ì‹¬ì´ ì±„íŒ… ì¤€ë¹„ ì™„ë£Œ (${CHAT_API_URL})`);
    })().catch(console.error);
  </script>
</body>
</html>
