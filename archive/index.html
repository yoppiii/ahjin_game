<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì•„ì§„ì´ ê²Œì„</title>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #f6f6f6;
      font-family: system-ui, -apple-system, "Apple SD Gothic Neo", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    #gameWrap {
      aspect-ratio: 3 / 4; /* iPad ì„¸ë¡œ */
      height: 100vh;
      max-height: 100vh;
      width: auto;
      background: #fff;
      border: 1px solid #ddd;
      position: relative;
      overflow: hidden;
    }

    canvas { width: 100%; height: 100%; display: block; }

    button {
      padding: 12px 18px;
      border-radius: 12px;
      border: 1px solid #cfcfcf;
      background: #fff;
      font-weight: 800;
      cursor: pointer;
    }
    button.active { border-color: #111; }

    /* ì¢Œì¸¡ ìƒë‹¨ */
    #genderUI {
      position: absolute;
      top: 16px;
      left: 16px;
      display: flex;
      gap: 8px;
      z-index: 30;
    }

    /* ë’¤ë¡œê°€ê¸°(ë©”ì¸ì—ì„œë§Œ) */
    #backBtn {
      position: absolute;
      top: 16px;
      left: 16px;
      z-index: 30;
      display: none;
    }

    /* ë°©ì†¡(í•­ìƒ ìœ ì§€) */
    #broadcastBtn {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      background: #ffe066;
      border-color: #f2c94c;
      z-index: 30;
    }

    /* ì‹œì‘(ì¸íŠ¸ë¡œì—ì„œë§Œ) */
    #startBtn {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 16px 48px;
      font-size: 20px;
      z-index: 30;
    }

    /* ë©”ì¸ UIëŠ” main_scene.jsì—ì„œ ì±„ì›€ */
    #mainUIRoot {
      position: absolute;
      inset: 0;
      z-index: 20;
      display: none;
      pointer-events: none;
    }
    #mainUIRoot .clickable { pointer-events: auto; }
  </style>
</head>

<body>
  <div id="gameWrap">
    <div id="genderUI">
      <button id="btnGirl" class="active">ì—¬ì</button>
      <button id="btnBoy">ë‚¨ì</button>
    </div>

    <button id="backBtn">ë’¤ë¡œ</button>
    <button id="broadcastBtn">ë°©ì†¡</button>
    <button id="startBtn">ì‹œì‘</button>

    <!-- ë©”ì¸ UIê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¶™ìŒ -->
    <div id="mainUIRoot"></div>

    <canvas id="game"></canvas>
  </div>

  <script type="module">
    import { createGame } from "./shared_canvas.js";

    // 1) ìº”ë²„ìŠ¤/ìºë¦­í„° ë Œë”(ê°€ë²¼ìš´ ê³µìš© ëª¨ë“ˆ)
    const game = await createGame({
      canvas: document.getElementById("game"),
      assets: { girl: "girl.png", boy: "boy.png" }
    });

    // 2) ì¸íŠ¸ë¡œ UI
    const genderUI = document.getElementById("genderUI");
    const btnGirl  = document.getElementById("btnGirl");
    const btnBoy   = document.getElementById("btnBoy");
    const startBtn = document.getElementById("startBtn");
    const backBtn  = document.getElementById("backBtn");
    const broadcastBtn = document.getElementById("broadcastBtn");
    const mainUIRoot = document.getElementById("mainUIRoot");

    btnGirl.onclick = () => {
      game.setGender("girl");
      btnGirl.classList.add("active");
      btnBoy.classList.remove("active");
    };
    btnBoy.onclick = () => {
      game.setGender("boy");
      btnBoy.classList.add("active");
      btnGirl.classList.remove("active");
    };

    broadcastBtn.onclick = () => alert("ğŸ“¡ ë°©ì†¡ (ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì—°ê²°)");

    let mainScene = null; // ë™ì  ë¡œë“œí•œ ë©”ì¸ ì”¬ í•¸ë“¤

    // 3) ì‹œì‘ ëˆ„ë¥´ë©´: ë¬´ê±°ìš´ ë©”ì¸ UI/ê¸°ëŠ¥ì„ ê·¸ë•Œ import()
    startBtn.onclick = async () => {
      startBtn.disabled = true;
      startBtn.textContent = "ë¡œë”©...";
      try {
        const mod = await import("./main_scene.js"); // âœ… ì—¬ê¸°ì„œë§Œ ë¡œë“œë¨
        mainScene = await mod.enterMainScene({
          root: mainUIRoot,
          onNavigate: (name) => alert("ë©”ë‰´: " + name),
        });

        // UI ìƒíƒœ ì „í™˜
        startBtn.style.display = "none";
        genderUI.style.display = "none";
        backBtn.style.display = "block";
        mainUIRoot.style.display = "block";

        // ìºë¦­í„° í¬ê¸° ìœ ì§€ + ìœ„ì¹˜ë§Œ ì¡°ì •
        game.setLayoutMode("main"); // ì•„ë˜ shared_canvas.jsì— êµ¬í˜„ë¨
      } catch (e) {
        console.error(e);
        alert("ë©”ì¸ ë¡œë”© ì‹¤íŒ¨: " + (e?.message || e));
      } finally {
        startBtn.disabled = false;
        startBtn.textContent = "ì‹œì‘";
      }
    };

    // 4) ë’¤ë¡œê°€ê¸°: ë©”ì¸ UI ì œê±°í•˜ê³  ì¸íŠ¸ë¡œë¡œ
    backBtn.onclick = () => {
      if (mainScene) {
        mainScene.destroy(); // ì´ë²¤íŠ¸ ì •ë¦¬
        mainScene = null;
      }
      mainUIRoot.innerHTML = "";
      mainUIRoot.style.display = "none";

      backBtn.style.display = "none";
      genderUI.style.display = "flex";
      startBtn.style.display = "block";

      game.setLayoutMode("intro");
    };
  </script>
</body>
</html>
